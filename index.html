<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulaire Salon</title>
  <style>
    .suggestions {
      border: 1px solid #ccc;
      max-height: 150px;
      overflow-y: auto;
      background: white;
      position: absolute;
      z-index: 1000;
      width: 300px;
    }
    .suggestions div {
      padding: 5px;
      cursor: pointer;
    }
    .suggestions div:hover {
      background: #f0f0f0;
    }
    .item {
      border-bottom: 1px solid #eee;
      padding: 6px;
      cursor: pointer;
    }
    .item:hover {
      background: #fafafa;
    }
    .selected-item {
      background: #e6ffe6 !important;
      border-left: 4px solid green;
    }
  </style>
</head>
<body>
  <h1>Inscription Praticien</h1>

  <form id="form">
    <input id="prenom" placeholder="Prénom" required />
    <input id="nom" placeholder="Nom" required />
    <input id="email" type="email" placeholder="Email" required />
    <input id="tel" placeholder="Téléphone" />
    <input id="q_raison" placeholder="Raison sociale" />
    <input id="q_adresse" placeholder="Adresse" />
    <div id="ban_suggestions" class="suggestions"></div>

    <div id="results"></div>

    <label for="affiliation">Type d'affiliation :</label>
    <select id="affiliation" required>
      <option value="">-- Choisir --</option>
      <option value="2">Affiliation CSP Classique</option>
      <option value="3">Affiliation CSPxSTG</option>
      <option value="4">Affiliation gracieuse</option>
    </select>

    <button type="submit">Envoyer</button>
  </form>

  <script>
    const PAPPERS_PROXY_URL = "/.netlify/functions/pappers";
    const NETLIFY_PROXY_URL = "/.netlify/functions/sendToMake";
    const PAPPERS_RESULT_SIZE = 50;
    const BAN_SUGGESTION_LIMIT = 5;

    const resultsEl = document.getElementById("results");
    const banSuggestionsEl = document.getElementById("ban_suggestions");
    const reasonInput = document.getElementById("q_raison");
    const addressInput = document.getElementById("q_adresse");

    let debounceTimer;
    let currentFetchController = null;
    let currentSelection = null;
    let postcodeFilter = "";
    let cityFilter = "";
    let lastBanSelectionValue = "";

    function escapeHtml(value = "") {
      const str = typeof value === "string" ? value : String(value ?? "");
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function escapeAttr(value = "") {
      return escapeHtml(value).replace(/`/g, "&#96;");
    }

    function buildCompanyAddress(siege = {}) {
      const parts = [];
      if (siege.adresse_ligne_1) {
        parts.push(siege.adresse_ligne_1);
      }
      const cpVille = `${(siege.code_postal || "").trim()} ${(siege.ville || "").trim()}`.trim();
      if (cpVille) {
        parts.push(cpVille);
      }
      return parts.join(", ");
    }

    function buildResultHtml(item) {
      const codeNAF = item.code_naf || "";
      const libelleNAF = item.libelle_code_naf || "Activité inconnue";
      const activite = codeNAF ? `${codeNAF} - ${libelleNAF}` : libelleNAF;
      const adresse = buildCompanyAddress(item.siege || {});
      const isMedical = codeNAF.startsWith("86");
      const isSelected = currentSelection && currentSelection.siren === (item.siren || "");

      if (isSelected) {
        currentSelection = {
          siren: item.siren || "",
          name: item.nom_entreprise || "",
          activite,
          adresse,
        };
      }

      const classes = ["item"];
      if (isSelected) {
        classes.push("selected-item");
      }

      const style = isMedical ? "color:green; font-weight:bold;" : "";

      return `
        <div class="${classes.join(" ")}"
             data-siren="${escapeAttr(item.siren || "")}"
             data-name="${escapeAttr(item.nom_entreprise || "")}"
             data-activite="${escapeAttr(activite)}"
             data-adresse="${escapeAttr(adresse)}">
          <strong>${escapeHtml(item.nom_entreprise || "")}</strong><br>
          <small style="${style}">${escapeHtml(activite)}</small><br>
          <small>${escapeHtml(adresse)}</small><br>
        </div>
      `;
    }

    function renderResults(items) {
      if (!Array.isArray(items) || items.length === 0) {
        resultsEl.innerHTML = "<p>Aucune entreprise trouvée</p>";
        return;
      }

      const sorted = items.slice().sort((a, b) => {
        const aMedical = String(a.code_naf || "").startsWith("86");
        const bMedical = String(b.code_naf || "").startsWith("86");
        if (aMedical === bMedical) {
          return 0;
        }
        return aMedical ? -1 : 1;
      });

      resultsEl.innerHTML = sorted.map((item) => buildResultHtml(item)).join("");
    }

    async function searchPappers() {
      const reason = reasonInput.value.trim();

      if (!reason) {
        resultsEl.innerHTML = "";
        return;
      }

      const params = new URLSearchParams();
      params.set("q", reason);
      params.set("taille", String(PAPPERS_RESULT_SIZE));
      if (postcodeFilter) {
        params.set("code_postal", postcodeFilter);
      }
      if (cityFilter) {
        params.set("ville", cityFilter);
      }

      if (currentFetchController) {
        currentFetchController.abort();
      }
      currentFetchController = new AbortController();

      resultsEl.innerHTML = "<p>Recherche…</p>";

      try {
        const url = `${PAPPERS_PROXY_URL}?${params.toString()}`;
        const res = await fetch(url, { signal: currentFetchController.signal });
        const data = await res.json();

        let items = Array.isArray(data.resultats) ? data.resultats : [];

        if (postcodeFilter) {
          const target = postcodeFilter.trim();
          items = items.filter((item) => {
            const cp = ((item.siege || {}).code_postal || "").trim();
            return cp.startsWith(target);
          });
        }

        if (!items.length) {
          resultsEl.innerHTML = "<p>Aucune entreprise trouvée</p>";
          return;
        }

        renderResults(items);
      } catch (err) {
        if (err.name === "AbortError") return;
        console.error("Erreur Pappers:", err);
        resultsEl.innerHTML = "<p>⚠️ Erreur de recherche</p>";
      } finally {
        currentFetchController = null;
      }
    }

    function scheduleSearch() {
      clearTimeout(debounceTimer);
      if (currentFetchController) {
        currentFetchController.abort();
        currentFetchController = null;
      }
      debounceTimer = setTimeout(() => {
        searchPappers();
      }, 250);
    }

    async function autocompleteBAN(query) {
      const trimmed = query.trim();
      if (trimmed.length < 3) {
        banSuggestionsEl.innerHTML = "";
        return;
      }

      try {
        const url = `https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(trimmed)}&limit=${BAN_SUGGESTION_LIMIT}`;
        const res = await fetch(url);
        const data = await res.json();
        const features = Array.isArray(data.features) ? data.features : [];

        const suggestions = features
          .map((feature) => {
            const props = feature.properties || {};
            const label = props.label || "";
            const postcode = props.postcode || "";
            const city = props.city || "";
            return `
              <div data-label="${escapeAttr(label)}"
                   data-postcode="${escapeAttr(postcode)}"
                   data-city="${escapeAttr(city)}">
                ${escapeHtml(label)}
              </div>
            `;
          })
          .join("");

        banSuggestionsEl.innerHTML = suggestions;
      } catch (err) {
        console.error("Erreur autocomplete BAN:", err);
      }
    }

    reasonInput.addEventListener("input", () => {
      scheduleSearch();
    });

    addressInput.addEventListener("input", (e) => {
      const value = e.target.value;

      if (value !== lastBanSelectionValue) {
        lastBanSelectionValue = "";
        cityFilter = "";
      }

      const manualMatch = value.match(/\b\d{5}\b/);
      if (manualMatch) {
        postcodeFilter = manualMatch[0];
      } else if (!lastBanSelectionValue) {
        postcodeFilter = "";
      }

      autocompleteBAN(value);
      scheduleSearch();
    });

    banSuggestionsEl.addEventListener("click", (e) => {
      const div = e.target.closest("div[data-label]");
      if (!div) return;

      const label = div.dataset.label || "";
      const postcode = div.dataset.postcode || "";
      const city = div.dataset.city || "";

      lastBanSelectionValue = label;
      postcodeFilter = postcode;
      cityFilter = city;

      addressInput.value = label;
      banSuggestionsEl.innerHTML = "";

      scheduleSearch();
    });

    resultsEl.addEventListener("click", (e) => {
      const div = e.target.closest(".item");
      if (!div) return;

      if (currentSelection && div.dataset.siren === currentSelection.siren) {
        div.classList.remove("selected-item");
        currentSelection = null;
        return;
      }

      currentSelection = {
        name: div.dataset.name || "",
        siren: div.dataset.siren || "",
        activite: div.dataset.activite || "",
        adresse: div.dataset.adresse || "",
      };

      resultsEl.querySelectorAll(".item").forEach((el) => el.classList.remove("selected-item"));
      div.classList.add("selected-item");
    });

    document.getElementById("form").addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!currentSelection) {
        alert("Choisis une entreprise");
        return;
      }

      const affiliationCode = document.getElementById("affiliation").value;
      if (!affiliationCode) {
        alert("Choisis un type d'affiliation");
        return;
      }

      const payload = {
        praticien: {
          prenom: document.getElementById("prenom").value,
          nom: document.getElementById("nom").value,
          email: document.getElementById("email").value,
          tel: document.getElementById("tel").value,
        },
        entreprise: currentSelection,
        affiliation: Number(affiliationCode),
        timestamp: new Date().toISOString(),
      };

      try {
        const response = await fetch(NETLIFY_PROXY_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (response.ok) {
          alert("✅ Données envoyées à Make via Netlify !");
        } else {
          const errText = await response.text().catch(() => "");
          console.error("Réponse proxy:", errText);
          alert("❌ Erreur côté proxy/Make");
        }
      } catch (err) {
        console.error("Erreur envoi webhook (proxy):", err);
        alert("⚠️ Erreur réseau (proxy)");
      }
    });
  </script>
</body>
</html>
