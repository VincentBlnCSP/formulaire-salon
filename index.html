diff --git a/index.html b/index.html
index b292a3baa91ea6e79900f3904b0b74b641b8e6cc..cdd90c70798475da9321032d26536f6506a80a98 100644
--- a/index.html
+++ b/index.html
@@ -65,139 +65,508 @@
   <script>
     const PAPPERS_PROXY_URL = "/.netlify/functions/pappers";
     const NETLIFY_PROXY_URL = "/.netlify/functions/sendToMake";
+    const DEFAULT_RESULT_SIZE = "10";
 
     const resultsEl = document.getElementById("results");
-   
+    const banSuggestionsEl = document.getElementById("ban_suggestions");
+
     let currentSelection = null;
     let debounceTimer;
     let currentFetchController = null;
 
+    function escapeHtml(value = "") {
+      const str = typeof value === "string" ? value : String(value);
+      return str
+        .replace(/&/g, "&amp;")
+        .replace(/</g, "&lt;")
+        .replace(/>/g, "&gt;")
+        .replace(/"/g, "&quot;")
+        .replace(/'/g, "&#39;");
+    }
+
+    function escapeAttr(value = "") {
+      return escapeHtml(value).replace(/`/g, "&#96;");
+    }
+
+    function buildPappersParams(rawParams = {}) {
+      const params = {};
+
+      if (typeof rawParams.q === "string") {
+        const trimmed = rawParams.q.trim();
+        if (trimmed.length >= 2) params.q = trimmed;
+      }
+
+      if (typeof rawParams.adresse === "string") {
+        const trimmed = rawParams.adresse.trim();
+        if (trimmed.length >= 3) params.adresse = trimmed;
+      }
+
+      if (typeof rawParams.code_postal === "string") {
+        const trimmed = rawParams.code_postal.trim();
+        if (trimmed.length >= 3) params.code_postal = trimmed;
+      }
+
+      if (typeof rawParams.ville === "string") {
+        const trimmed = rawParams.ville.trim();
+        if (trimmed.length >= 2) params.ville = trimmed;
+      }
+
+      if (typeof rawParams.code_naf === "string") {
+        const trimmed = rawParams.code_naf.trim();
+        if (trimmed) params.code_naf = trimmed;
+      }
+
+      if (rawParams.taille) {
+        params.taille = String(rawParams.taille);
+      }
+
+      if (!params.taille) {
+        params.taille = DEFAULT_RESULT_SIZE;
+      }
+
+      const hasSearchCriteria = params.q || params.adresse || params.code_postal || params.ville;
+      if (!hasSearchCriteria) {
+        return null;
+      }
+
+      return params;
+    }
+
+    function buildQueryString(params) {
+      const searchParams = new URLSearchParams();
+      Object.entries(params).forEach(([key, value]) => {
+        if (value !== undefined && value !== null && value !== "") {
+          searchParams.append(key, value);
+        }
+      });
+      return searchParams.toString();
+    }
+
+    function normalizeAddress(value) {
+      if (!value) return "";
+      return String(value)
+        .normalize("NFD")
+        .replace(/[\u0300-\u036f]/g, "")
+        .replace(/[^0-9A-Z]/gi, " ")
+        .replace(/\s+/g, " ")
+        .trim()
+        .toUpperCase();
+    }
+
+    function filterResultsByAddress(items, filterConfig = {}) {
+      if (!Array.isArray(items) || items.length === 0) {
+        return [];
+      }
+
+      const {
+        label = "",
+        street = "",
+        housenumber = "",
+        city = "",
+        postcode = "",
+        relaxNumber = false,
+        ignoreCityMismatch = false,
+        allowLabelMatch = false,
+        requirePostcodeMatch = false,
+      } = filterConfig;
+
+      const normalizedStreetWithNumber = normalizeAddress([housenumber, street].filter(Boolean).join(" "));
+      const normalizedStreet = normalizeAddress(street);
+      const normalizedCity = normalizeAddress(city);
+      const normalizedLabel = normalizeAddress(label);
+      const normalizedPostcode = normalizeAddress(postcode);
+
+      return items.filter((item) => {
+        const siege = item.siege || {};
+        const addressLines = [
+          siege.adresse_ligne_1,
+          siege.adresse_ligne_2,
+          siege.adresse_ligne_3,
+          siege.adresse_ligne_4,
+          siege.adresse_ligne_5,
+          siege.adresse_ligne_6,
+          [siege.code_postal, siege.ville].filter(Boolean).join(" "),
+        ]
+          .map(normalizeAddress)
+          .filter(Boolean);
+
+        if (addressLines.length === 0) {
+          return false;
+        }
+
+        let matchesStreet = false;
+        if (normalizedStreetWithNumber) {
+          matchesStreet = addressLines.some((line) => line.includes(normalizedStreetWithNumber));
+        }
+
+        if (!matchesStreet && relaxNumber && normalizedStreet) {
+          matchesStreet = addressLines.some((line) => line.includes(normalizedStreet));
+        }
+
+        if (!matchesStreet && allowLabelMatch && normalizedLabel) {
+          matchesStreet = addressLines.some((line) => line.includes(normalizedLabel));
+        }
+
+        if (!matchesStreet) {
+          return false;
+        }
+
+        if (requirePostcodeMatch && normalizedPostcode) {
+          const candidatePostcode = normalizeAddress(siege.code_postal || "");
+          if (!candidatePostcode || candidatePostcode !== normalizedPostcode) {
+            return false;
+          }
+        }
+
+        if (normalizedCity && !ignoreCityMismatch) {
+          const candidateCity = normalizeAddress(siege.ville || "");
+          if (!candidateCity) {
+            return false;
+          }
+          const cityMatches =
+            candidateCity === normalizedCity ||
+            candidateCity.includes(normalizedCity) ||
+            normalizedCity.includes(candidateCity);
+          if (!cityMatches) {
+            return false;
+          }
+        }
+
+        return true;
+      });
+    }
+
+    function renderResults(items) {
+      if (!Array.isArray(items) || items.length === 0) {
+        resultsEl.innerHTML = "<p>Aucune entreprise trouvée</p>";
+        return;
+      }
+
+      const dentalItems = [];
+      const otherItems = [];
+
+      items
+        .filter((item) => !currentSelection || item.siren !== currentSelection.siren)
+        .forEach((item) => {
+          const codeNAF = item.code_naf || "";
+          const libelleNAF = item.libelle_code_naf || "Activité inconnue";
+          const activite = codeNAF ? `${codeNAF} - ${libelleNAF}` : libelleNAF;
+          const siege = item.siege || {};
+          const adresseParts = [];
+          if (siege.adresse_ligne_1) {
+            adresseParts.push(siege.adresse_ligne_1);
+          }
+          const cpVille = `${(siege.code_postal || "").trim()} ${(siege.ville || "").trim()}`.trim();
+          if (cpVille) {
+            adresseParts.push(cpVille);
+          }
+          const adresse = adresseParts.join(", ");
+
+          const isDental = codeNAF.startsWith("86");
+          const style = isDental ? "color:green; font-weight:bold;" : "";
+
+          const html = `
+      <div class="item"
+           data-siren="${escapeAttr(item.siren || "")}" 
+           data-name="${escapeAttr(item.nom_entreprise || "")}"
+           data-activite="${escapeAttr(activite)}"
+           data-adresse="${escapeAttr(adresse)}">
+        <strong>${escapeHtml(item.nom_entreprise || "")}</strong><br>
+        <small style="${style}">${escapeHtml(activite)}</small><br>
+        <small>${escapeHtml(adresse)}</small><br>
+      </div>
+    `;
+
+          if (isDental) {
+            dentalItems.push(html);
+          } else {
+            otherItems.push(html);
+          }
+        });
+
+      let pinned = "";
+      if (currentSelection) {
+        pinned = `
+    <div class="item selected-item"
+         data-siren="${escapeAttr(currentSelection.siren || "")}" 
+         data-name="${escapeAttr(currentSelection.name)}"
+         data-activite="${escapeAttr(currentSelection.activite || "")}" 
+         data-adresse="${escapeAttr(currentSelection.adresse || "")}">
+      <strong>${escapeHtml(currentSelection.name)}</strong><br>
+      <small>${escapeHtml(currentSelection.activite || "")}</small><br>
+      <small>${escapeHtml(currentSelection.adresse || "")}</small><br>
+    </div>
+  `;
+      }
+
+      resultsEl.innerHTML = pinned + dentalItems.join("") + otherItems.join("");
+    }
+
+    function createAddressSearchAttempts(addressData = {}) {
+      const base = {
+        label: addressData.label || "",
+        housenumber: addressData.housenumber || "",
+        street: addressData.street || "",
+        postcode: addressData.postcode || "",
+        city: addressData.city || "",
+      };
+
+      const attempts = [];
+      const seen = new Set();
+
+      const streetLine = [base.housenumber, base.street].filter(Boolean).join(" ").trim();
+      const labelFallback = [streetLine, base.postcode, base.city].filter(Boolean).join(" ").trim() || base.label;
+      const queryWithCity = [streetLine, base.city].filter(Boolean).join(" ").trim();
+      const queryWithPostcode = [streetLine, base.postcode].filter(Boolean).join(" ").trim();
+
+      function pushAttempt(rawParams, filterOverrides) {
+        const paramsCopy = { ...rawParams };
+        Object.keys(paramsCopy).forEach((key) => {
+          if (typeof paramsCopy[key] === "string") {
+            const trimmed = paramsCopy[key].trim();
+            if (!trimmed) {
+              delete paramsCopy[key];
+            } else {
+              paramsCopy[key] = trimmed;
+            }
+          }
+        });
+
+        const prepared = buildPappersParams(paramsCopy);
+        if (!prepared) return;
+
+        const signature = JSON.stringify(prepared);
+        const filterConfig = filterOverrides
+          ? { ...base, ...filterOverrides }
+          : null;
+        const signatureKey = `${signature}::${filterConfig ? JSON.stringify(filterOverrides) : ""}`;
+        if (seen.has(signatureKey)) return;
+        seen.add(signatureKey);
+
+        attempts.push({
+          params: paramsCopy,
+          addressFilter: filterConfig,
+          signature,
+        });
+      }
+
+      if (streetLine) {
+        pushAttempt(
+          {
+            adresse: streetLine,
+            code_postal: base.postcode,
+            ville: base.city,
+            q: queryWithPostcode || labelFallback || base.label,
+          },
+          { relaxNumber: false }
+        );
+        pushAttempt(
+          {
+            adresse: streetLine,
+            code_postal: base.postcode,
+            ville: base.city,
+            q: queryWithPostcode || labelFallback || base.label,
+          },
+          { relaxNumber: true }
+        );
+        pushAttempt(
+          {
+            adresse: streetLine,
+            code_postal: base.postcode,
+            ville: base.city,
+            q: queryWithPostcode || labelFallback || base.label,
+          },
+          { relaxNumber: true, ignoreCityMismatch: true }
+        );
+      }
+
+      if (streetLine) {
+        pushAttempt(
+          {
+            adresse: streetLine,
+            ville: base.city,
+            q: queryWithCity || labelFallback || base.label,
+          },
+          { relaxNumber: false }
+        );
+        pushAttempt(
+          {
+            adresse: streetLine,
+            ville: base.city,
+            q: queryWithCity || labelFallback || base.label,
+          },
+          { relaxNumber: true }
+        );
+        pushAttempt(
+          {
+            adresse: streetLine,
+            ville: base.city,
+            q: queryWithCity || labelFallback || base.label,
+          },
+          { relaxNumber: true, ignoreCityMismatch: true }
+        );
+      }
+
+      if (streetLine) {
+        pushAttempt(
+          {
+            q: [streetLine, base.postcode].filter(Boolean).join(" "),
+          },
+          { relaxNumber: true, ignoreCityMismatch: true }
+        );
+      }
+
+      if (streetLine) {
+        pushAttempt(
+          {
+            q: [streetLine, base.city].filter(Boolean).join(" "),
+          },
+          { relaxNumber: true }
+        );
+        pushAttempt(
+          {
+            q: [streetLine, base.city].filter(Boolean).join(" "),
+          },
+          { relaxNumber: true, ignoreCityMismatch: true }
+        );
+      }
+
+      if (labelFallback || base.label) {
+        const finalLabel = base.label || labelFallback;
+        pushAttempt(
+          { q: finalLabel },
+          { relaxNumber: true, allowLabelMatch: true, ignoreCityMismatch: true }
+        );
+      }
+
+      if (streetLine) {
+        pushAttempt({ q: streetLine }, null);
+      }
+
+      return attempts;
+    }
+
     // --- Autocomplete BAN ---
     async function autocompleteBAN(query) {
       if (query.length < 3) {
-        document.getElementById("ban_suggestions").innerHTML = "";
+        banSuggestionsEl.innerHTML = "";
         return;
       }
       try {
         const res = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`);
         const data = await res.json();
 
-        const suggestions = (data.features || []).map(f =>
-          `<div data-address="${f.properties.label}">${f.properties.label}</div>`
-        ).join("");
-
-        document.getElementById("ban_suggestions").innerHTML = suggestions;
+        const suggestions = (data.features || []).map((feature) => {
+          const props = feature.properties || {};
+          const attrPairs = [
+            ["data-address", props.label || ""],
+            ["data-housenumber", props.housenumber || ""],
+            ["data-street", props.street || ""],
+            ["data-postcode", props.postcode || ""],
+            ["data-city", props.city || ""],
+          ]
+            .map(([key, value]) => `${key}="${escapeAttr(value)}"`)
+            .join(" ");
+
+          return `<div ${attrPairs}>${escapeHtml(props.label || "")}</div>`;
+        }).join("");
+
+        banSuggestionsEl.innerHTML = suggestions;
       } catch (err) {
         console.error("Erreur autocomplete BAN:", err);
       }
     }
 
-    // --- Recherche Pappers (toujours via q=) ---
-    async function searchPappers(type, value) {
-      const query = (value || "").trim();
-      if (query.length < 2) {
-        resultsEl.innerHTML = "";
+    // --- Recherche Pappers ---
+    async function searchPappers(rawParams = {}, options = {}) {
+      const fallbackQueue = Array.isArray(options.fallbacks) ? [...options.fallbacks] : [];
+      const params = buildPappersParams(rawParams);
+
+      if (!params) {
+        if (fallbackQueue.length > 0) {
+          const nextAttempt = fallbackQueue.shift();
+          searchPappers(nextAttempt.params, {
+            addressFilter: nextAttempt.addressFilter,
+            fallbacks: fallbackQueue,
+            signature: nextAttempt.signature,
+          });
+        } else {
+          resultsEl.innerHTML = "";
+        }
         return;
       }
 
+      const signature = options.signature || JSON.stringify(params);
+
       if (currentFetchController) currentFetchController.abort();
       currentFetchController = new AbortController();
 
       resultsEl.innerHTML = "<p>Recherche…</p>";
 
       try {
-        const url = `${PAPPERS_PROXY_URL}?q=${encodeURIComponent(query)}&taille=10`;
+        const queryString = buildQueryString(params);
+        const url = `${PAPPERS_PROXY_URL}?${queryString}`;
         const res = await fetch(url, { signal: currentFetchController.signal });
         const data = await res.json();
 
-        const items = data.resultats || [];
-        if (items.length === 0) {
+        const items = Array.isArray(data.resultats) ? data.resultats : [];
+
+        let filteredItems = options.addressFilter
+          ? filterResultsByAddress(items, options.addressFilter)
+          : items;
+
+        if (filteredItems.length === 0) {
+          while (fallbackQueue.length > 0) {
+            const nextAttempt = fallbackQueue.shift();
+
+            if (nextAttempt.signature && nextAttempt.signature === signature) {
+              const reuseFiltered = nextAttempt.addressFilter
+                ? filterResultsByAddress(items, nextAttempt.addressFilter)
+                : items;
+              if (reuseFiltered.length > 0) {
+                renderResults(reuseFiltered);
+                return;
+              }
+              continue;
+            }
+
+            searchPappers(nextAttempt.params, {
+              addressFilter: nextAttempt.addressFilter,
+              fallbacks: fallbackQueue,
+              signature: nextAttempt.signature,
+            });
+            return;
+          }
+
           resultsEl.innerHTML = "<p>Aucune entreprise trouvée</p>";
           return;
         }
 
-   // 1) Construire la liste des résultats normalement,
-//    en excluant le doublon si c'est l'entreprise sélectionnée
-// Sépare en deux listes
-const dentalItems = [];
-const otherItems = [];
-
-items
-  .filter(item => !currentSelection || item.siren !== currentSelection.siren)
-  .forEach(item => {
-    const codeNAF = item.code_naf || "";
-    const libelleNAF = item.libelle_code_naf || "Activité inconnue";
-    const activite = codeNAF ? `${codeNAF} - ${libelleNAF}` : libelleNAF;
-    const adresse = item.siege ? `${item.siege.adresse_ligne_1 || ""}, ${item.siege.code_postal || ""} ${item.siege.ville || ""}` : "";
-
-    const isDental = codeNAF.startsWith("86"); 
-    const style = isDental ? "color:green; font-weight:bold;" : "";
-
-    const html = `
-      <div class="item" 
-           data-siren="${item.siren}" 
-           data-name="${item.nom_entreprise}"
-           data-activite="${activite}"
-           data-adresse="${adresse}"
-        <strong>${item.nom_entreprise}</strong><br>
-        <small style="${style}">${activite}</small><br>
-        <small>${adresse}</small><br>
-      </div>
-    `;
-
-    if (isDental) {
-      dentalItems.push(html); // en haut
-    } else {
-      otherItems.push(html);
-    }
-  });
-
-// 1) Construire le bloc "pinned" si sélection
-let pinned = "";
-if (currentSelection) {
-  pinned = `
-    <div class="item selected-item"
-         data-siren="${currentSelection.siren}" 
-         data-name="${currentSelection.name}"
-         data-activite="${currentSelection.activite || ""}"
-         data-adresse="${currentSelection.adresse || ""}"
-      <strong>${currentSelection.name}</strong><br>
-      <small>${currentSelection.activite || ""}</small><br>
-      <small>${currentSelection.adresse || ""}</small><br>
-    </div>
-  `;
-}
-
-// 2) Injecter dans l’ordre : pinned (si existe) → dental → autres
-resultsEl.innerHTML = pinned + dentalItems.join("") + otherItems.join("");
-
-
-
-
+        renderResults(filteredItems);
       } catch (err) {
         if (err.name === "AbortError") return;
         console.error("Erreur Pappers:", err);
         resultsEl.innerHTML = "<p>⚠️ Erreur de recherche</p>";
+      } finally {
+        currentFetchController = null;
       }
     }
-
     // --- Raccrocher la recherche avec debounce ---
-    function attachSearch(inputId, type) {
-  const input = document.getElementById(inputId);
-  input.addEventListener("input", (e) => {
-    const value = e.target.value;
-
-    clearTimeout(debounceTimer);
-    if (currentFetchController) currentFetchController.abort();
-
-    debounceTimer = setTimeout(() => {
-      searchPappers(type, value);
-    }, 250);
-  });
-}
-
+    function attachSearch(inputId) {
+      const input = document.getElementById(inputId);
+      input.addEventListener("input", (e) => {
+        const value = e.target.value;
+
+        clearTimeout(debounceTimer);
+        if (currentFetchController) currentFetchController.abort();
+
+        debounceTimer = setTimeout(() => {
+          searchPappers({ q: value });
+        }, 250);
+      });
+    }
 
-    attachSearch("q_raison", "raison");
+    attachSearch("q_raison");
 
     // --- Spécial adresse BAN ---
     const inputAdresse = document.getElementById("q_adresse");
@@ -205,26 +574,37 @@ resultsEl.innerHTML = pinned + dentalItems.join("") + otherItems.join("");
       autocompleteBAN(e.target.value);
     });
 
-    document.getElementById("ban_suggestions").addEventListener("click", (e) => {
+    banSuggestionsEl.addEventListener("click", (e) => {
       const div = e.target.closest("div");
       if (!div) return;
 
-      const selectedAddress = div.dataset.address;
+      const selectedAddress = div.dataset.address || "";
       inputAdresse.value = selectedAddress;
-      document.getElementById("ban_suggestions").innerHTML = "";
-
-      // Recherche Pappers avec adresse complète
-      searchPappers("adresse", selectedAddress);
-
-      // Si trop de résultats → relancer avec Rue+Ville
-      setTimeout(() => {
-        const items = document.querySelectorAll("#results .item");
-        if (items.length > 30) {
-          const parts = selectedAddress.split(",");
-          const rueVille = parts.slice(0, 2).join(" ");
-          searchPappers("adresse", rueVille);
+      banSuggestionsEl.innerHTML = "";
+
+      const addressContext = {
+        label: selectedAddress,
+        housenumber: div.dataset.housenumber || "",
+        street: div.dataset.street || "",
+        postcode: div.dataset.postcode || "",
+        city: div.dataset.city || "",
+      };
+
+      const attempts = createAddressSearchAttempts(addressContext);
+
+      if (!attempts.length) {
+        if (addressContext.label) {
+          searchPappers({ q: addressContext.label });
         }
-      }, 1500);
+        return;
+      }
+
+      const [firstAttempt, ...fallbackAttempts] = attempts;
+      searchPappers(firstAttempt.params, {
+        addressFilter: firstAttempt.addressFilter,
+        fallbacks: fallbackAttempts,
+        signature: firstAttempt.signature,
+      });
     });
 
     // --- Sélection d'une entreprise ---
